query.on('end',()=>{ connection.release(); writeArray = itemArray.slice(0), alteredArray = []; var csv = json2csv({data: writeArray,fields:fields}), timestamp = new Date(Date.now()); timestamp = timestamp.getFullYear() + '-' +(timestamp.getMonth() + 1) + '-' + timestamp.getDate()+ ' '+timestamp.getHours() +':'+timestamp.getMinutes()+':'+timestamp.getSeconds(); let fpath = './public/assets/archives/opalEdiInventory-'+timestamp+'.csv'; while(itemArray.length > 0){ alteredArray = itemArray.splice(0,999); for(let i = 0; i < alteredArray.length; i++){ jsonObjectArray.push({ sku: alteredArray[i]['sku'], quantity: alteredArray[i]["quantity"], overstockquantity: alteredArray[i]["osInv"], warehouse: warehouse, isdiscontinued: alteredArray[i]["disc"], backorderdate: alteredArray[i]["etd"], backorderavailability: alteredArray[i]["boq"] }); } var jsonObject = { login: user, password: password, items: jsonObjectArray }; postOptions.url = endpoint; postOptions.body = JSON.stringify(jsonObject); funcArray.push({func:function(postOptions){request(postOptions,(err,res,body)=>{if(err){console.error(err);throw err;}console.log(body);})},vars:postOptions}); jsonObjectArray.length = 0; } var mili = 180000; for(let i = 0;i < funcArray.length; i++){ setTimeout(()=>{ var d = JSON.parse(funcArray[i]['vars'].body); console.log(d); console.log('request '+ i); //funcArray[i]['func'](funcArray[i]['vars']); }, mili * i); } }); });
